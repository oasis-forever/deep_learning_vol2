import unittest
import numpy as np
from numpy.testing import assert_almost_equal
import sys
sys.path.append("../lib/concerns")
sys.path.append("../lib/layers")
from lstm import LSTM

class TestLSTM(unittest.TestCase):
    def setUp(self):
        Wx = np.array([
            [
                9.72009451e-01, -4.97642862e-01,  6.45448952e-01,
                8.10387855e-01,  1.13757673e+00, -5.27114694e-01,
                -9.08624540e-01, 1.61896844e+00, -1.16690977e+00,
                3.93476226e-01, -6.04018422e-01,  5.67830817e-01
            ],
            [
                 6.68131790e-01,  6.40157016e-01,  6.90200961e-01,
                -1.39750585e+00, -4.89624070e-01,  8.99789953e-01,
                 3.97067428e-04,  1.47459503e+00, -4.95030269e-01,
                -9.22541855e-01, -1.57352198e-01, -1.67160494e+00
            ],
            [
                 6.93508859e-01, -9.23177216e-01, -4.83511551e-01,
                -1.18675890e+00, -7.35505045e-01, -1.61403611e+00,
                -2.76067694e-02, -2.48294747e-01,  1.14474446e+00,
                 1.86354309e-01, -1.73018002e+00, -4.82520536e-03
            ]
        ])
        Wh = np.array([
            [
                -0.88480318,  1.09509583,  0.55657863,
                -0.35096014,  0.18572107,  0.83823659,
                -0.44063768, -0.80897913,  0.35752315,
                 1.65812611,  1.40425671,  1.52519905
            ],
            [
                -0.22279229,  1.16363656, -0.47632291,
                -0.16436909, -2.16120359,  0.28362134,
                 0.01817155,  0.04836914, -0.30831619,
                -2.0992645 , -0.07302497, -0.72868125
            ],
            [
                -1.40551611,  2.12755955,  1.76232202,
                 2.15703084, -1.87387492,  1.22755896,
                -0.84271588,  1.07860737, -0.35473314,
                -0.86293879,  1.67287773,  0.41575087
            ]
        ])
        b = np.array([
            0.46861655,  0.15954682,  0.38782221,
            1.00791178, -0.38322573,  0.83138721,
            0.98675017, -0.83388618,  1.14392808,
            0.37846653,  0.47617248,  -1.8035631
        ])
        self.lstm = LSTM(Wx, Wh, b)
        self.x = np.array([
            [ 0.32434964, -1.25234162, -1.11446048],
            [-1.00333386, -0.28908588,  0.80944727],
            [-1.12554591,  0.00812256, -0.17046584],
            [-0.32813507,  0.16989344,  0.53355169],
            [-0.4869515 ,  0.1677294 , -0.12831696],
            [ 0.05832905, -0.32864825, -0.80026008],
            [-0.02647765, -0.7902213 ,  0.15894066],
            [ 0.6531385 ,  0.89562313,  0.29789637],
            [ 2.10234369, -0.29459709,  0.10299345],
            [-0.27252854,  2.00320793,  0.45730897],
            [ 1.5004658 ,  1.64225418,  1.18133581],
            [-0.24243905, -0.43939872, -0.13251067]
        ])
        self.h_prev = np.array([
            [-0.10935227, -0.44314754,  1.08169975],
            [-1.21809561, -0.71525211, -1.02789959],
            [-0.95964908, -0.51143773,  0.21415223],
            [ 1.67953394, -0.35025546, -0.38320191],
            [ 0.44725308, -1.12955008,  1.75971301],
            [ 0.28200635, -0.0879721 ,  0.08046973],
            [-0.57840066, -0.05648079,  0.73577611],
            [-0.95991989, -0.42672155,  0.87126791],
            [-0.61249768, -1.27271833, -1.17150149],
            [ 0.62112557,  0.01982296,  1.98008052],
            [-0.47977218, -0.24977873, -0.56312278],
            [ 0.479705  ,  0.34781637, -0.07003237]
        ])
        self.c_prev = np.array([
            [ 1.31482411, -0.77629214,  0.58700115],
            [-1.06531026, -0.87934991,  0.62284509],
            [-0.60934138, -0.99160926, -0.42251352],
            [-0.23641619,  0.46826475, -0.02462736],
            [-0.12147368, -1.00207905, -0.12701465],
            [ 1.07820838,  0.51889022, -1.68135737],
            [ 2.21903061, -2.61861404,  1.16692287],
            [-1.49690178,  0.29867214, -0.85135438],
            [ 1.59958995, -0.86312955,  1.00291727],
            [-0.61192179, -0.29602751,  0.78903217],
            [-0.04484411, -0.13443395, -0.6548083 ],
            [-0.9392424 , -1.23116816,  1.26848987]
        ])

    def test_forward(self):
        c_next, h_next = self.lstm.forward(self.x, self.h_prev, self.c_prev)
        assert_almost_equal(np.array([
            [ 0.59989084, -0.56519862,  0.98400225],
            [-1.91850874,  0.02352198, -0.93321127],
            [ 0.45227288, -0.54703237,  0.48403159],
            [-0.73615581,  0.32063485,  0.7548738 ],
            [ 0.42491665, -1.47394193,  0.67068475],
            [ 1.05754984,  0.49689304, -0.61805755],
            [ 1.49972308, -1.83582377,  1.00702007],
            [-0.74679837, -0.61435311, -0.45936825],
            [ 1.99958655,  0.77989824,  0.03898481],
            [ 0.18246256, -1.25613678,  1.4088285 ],
            [-0.60443486,  0.78677923, -0.91444947],
            [ 0.27892748, -0.94084206,  1.31430749]
        ]), c_next)
        assert_almost_equal(np.array([
            [ 4.19169498e-01, -5.03430077e-01,  5.64198599e-01],
            [-6.54667825e-01,  5.95397055e-04, -1.84025417e-02],
            [ 1.30830713e-01, -3.09895913e-01,  1.37309301e-02],
            [-6.16008036e-01,  2.51996674e-01,  3.79084583e-01],
            [ 3.33833747e-01, -8.91544720e-01,  2.74736749e-01],
            [ 5.94326869e-01,  4.21936364e-01, -1.83699519e-01],
            [ 3.74427572e-01, -6.48435544e-01,  2.00609507e-01],
            [-1.07885596e-01, -2.15141706e-01, -1.01425325e-02],
            [ 9.49238782e-01,  1.64936528e-02,  1.37032403e-02],
            [ 1.78080877e-02, -8.29836071e-01,  2.47025891e-02],
            [-2.55087741e-01,  8.53326914e-03, -8.05473776e-03],
            [ 1.86996338e-01, -5.96078729e-01,  2.76307207e-01]
        ]), h_next)

    def test_backward(self):
        dc_next, dh_next = self.lstm.forward(self.x, self.h_prev, self.c_prev)
        dx, dh_prev, dc_prev = self.lstm.backward(dc_next, dh_next)
        assert_almost_equal(np.array([
            [-6.79930933e-01, -1.97518363e-01,  4.16860765e-01],
            [ 1.55034826e-01, -2.91419470e-01,  1.71192005e-01],
            [-3.70136768e-02,  1.71824890e-02, -3.38419828e-01],
            [-3.05073579e-01,  2.41424747e-01, -1.93659638e-01],
            [ 1.54819264e-01,  2.30288841e-01,  2.25717407e-02],
            [ 5.45401813e-01,  4.42172325e-02, -1.86619072e-01],
            [-3.13126336e-04,  3.56652426e-01, -1.26116627e+00],
            [-3.60309927e-02,  5.69443437e-03,  1.46531343e-02],
            [ 1.11857111e-01, -4.33420556e-01, -3.87583328e-01],
            [ 5.95012499e-02, -6.50019034e-03, -5.01780050e-02],
            [-6.99925197e-02, -8.10853281e-02,  1.01525160e-02],
            [-8.53223995e-02, -2.06294786e-01, -7.03297008e-01]
        ]), dx)
        assert_almost_equal(np.array([
            [ 0.34687254,  0.38344684,  0.37401971],
            [ 0.64098696, -0.85045992, -0.5425016 ],
            [ 0.26924398,  0.14994028,  0.69949726],
            [ 0.35040516, -0.01098271, -0.15074927],
            [-0.02868001,  0.07799114,  0.39807372],
            [ 0.18752975, -0.67098506, -0.33199641],
            [ 1.6726196 , -0.19763998,  1.64359161],
            [ 0.15319373,  0.05884558,  0.22297725],
            [-0.13909709, -0.11303457,  0.49671851],
            [ 0.05830494, -0.03137801,  0.10292926],
            [ 0.11062537, -0.18552512, -0.17265588],
            [ 0.94321997,  0.11497126,  1.47405578]
        ]), dh_prev)
        assert_almost_equal(np.array([
            [ 7.84603591e-02, -7.93934519e-01,  8.02468649e-01],
            [-7.07422789e-01,  1.15401664e-05, -1.38975207e-03],
            [ 1.18023605e-01, -2.39578791e-01,  1.17225299e-02],
            [-4.65581356e-01,  3.09765349e-01,  3.95637732e-01],
            [ 4.36409729e-02, -1.13529451e+00,  4.74057958e-01],
            [ 3.21235172e-01,  5.77017648e-01, -2.34804219e-01],
            [ 1.85468079e-01, -4.58247852e-01,  2.10825777e-01],
            [-1.53895902e-01, -2.33683523e-01, -1.75307671e-02],
            [ 1.08007772e+00,  8.27308200e-05,  1.16063117e-02],
            [ 6.54400485e-03, -1.16746148e+00,  3.28679438e-02],
            [-4.54490114e-01,  9.55363471e-04, -8.84788951e-03],
            [ 1.32898508e-01, -6.72948492e-01,  1.87992760e-01]
        ]), dc_prev)

if __name__ == "__main__":
    unittest.main()
