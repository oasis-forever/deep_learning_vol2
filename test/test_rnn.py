import unittest
import numpy as np
from numpy.testing import assert_almost_equal
import sys
sys.path.append("../lib/layers")
from rnn import RNN

class TestRNN(unittest.TestCase):
    def setUp(self):
        Wx = np.array([
            [-0.22188903,  0.08386875, -0.75546985],
            [-0.16539038, -0.77417432, -2.0647902 ],
            [ 0.67699682,  0.16134384,  1.07681088]
        ])
        Wh = np.array([
            [ 0.02754815,  1.20705983,  1.71152808],
            [-0.78202214,  0.82526956,  0.29340149],
            [-1.74805756, -0.70864726,  0.07484916],
            [-0.78954396, -0.09472629, -0.69079382],
            [ 0.97462724, -0.38203782,  0.73984557],
            [-2.25074178, -1.86560587,  0.90426399],
            [-1.40055181,  0.07963091, -0.50237517]
        ])
        b  = np.array([-0.12560449, -0.88177588,  0.16127911])
        self.rnn = RNN(Wx, Wh, b)
        self.x = np.array([
            [-0.50049832, -0.29649533, -0.32459084],
            [-0.95128178, -0.5628901 ,  0.86422119],
            [-0.47433702,  2.10351595, -0.22785074],
            [ 0.14618326,  0.29712952, -0.2422674 ],
            [ 0.75166244,  0.08669683,  0.53630348],
            [ 0.2082006 ,  0.80298143, -0.31219377],
            [ 1.41595997, -0.64171257,  1.24747101]
        ])
        self.h_prev = np.array([
            [-0.65461975, -0.84657572,  0.39192836, -1.24758748, -0.67793533,  0.73434434,  0.02352183],
            [ 1.0825732 ,  0.13239711, -2.61913172,  0.72120615,  0.66882916, -1.54572931, -2.12476262],
            [-0.90918443,  1.33161436, -1.78989875,  0.59264775,  1.45147977,   1.3814514,  0.52184751],
            [-0.7234173 , -0.51390412,  0.40127155,  0.08365961,  0.87067767, -0.32861441,  1.50162384],
            [ 1.91974834, -0.51109037,  0.33781316,  -0.4808273,  0.16545944,    0.928154,   0.7940114],
            [-0.90789648, -0.57156544,  0.01586192, -1.17176013,  0.55876523,  -0.4950408, -1.35532488],
            [-0.02122447, -0.62143019, -1.26626015,  0.23991243,  0.04197884, -1.93527659,  0.27700832]
        ])

    def test_forward(self):
        h_next = self.rnn.forward(self.x, self.h_prev)
        assert_almost_equal(np.array([
            [-0.91981702, -0.99819272,  0.44231054],
            [ 1.        ,  0.99994776,  0.99965658],
            [-0.87487609, -0.99973439, -0.99881884],
            [-0.8542389 , -0.98117864, -0.99001876],
            [-0.99172558, -0.68007693,  0.99939057],
            [ 0.99967376, -0.98373955, -0.97822062],
            [ 0.99999843,  0.99916043, -0.52078209]
        ]), h_next)

    def test_backward(self):
        h_next = self.rnn.forward(self.x, self.h_prev)
        dx, dh_prev = self.rnn.backward(h_next)
        assert_almost_equal(np.array([
            [-2.37663460e-01, -7.08397011e-01,  2.86665114e-01],
            [-5.09860696e-04, -1.49834045e-03,  7.56076874e-04],
            [ 4.72772012e-02,  3.92246701e-02, -1.41570947e-01],
            [ 6.30173180e-02,  1.07113095e-01, -1.83383242e-01],
            [-2.79506507e-02,  2.83179029e-01, -6.87308881e-02],
            [ 2.90340601e-02,  1.11481036e-01, -5.00616050e-02],
            [ 2.86870003e-01,  7.82368962e-01, -4.08418703e-01]
        ]), dx)
        assert_almost_equal(np.array([
            [ 6.00671413e-01,  2.12140047e-01,  2.76697827e-01, -1.33633113e-01,  1.26596644e-01,  6.47132379e-01,  1.92882616e-02],
            [ 1.30105498e-03,  2.87637014e-04, -2.26529412e-05, -4.84120029e-04,  4.67983790e-04,  4.25859261e-04, -3.36556632e-04],
            [-1.03309233e-02,  1.59371170e-01,  3.58969004e-01,  1.63724330e-01, -2.01573104e-01,  4.60797784e-01,  2.88589938e-01],
            [-8.41791312e-02,  1.44589935e-01,  4.28047009e-01,  1.99339961e-01, -2.25593399e-01,  5.70125972e-01,  3.30325240e-01],
            [-4.39592510e-01, -2.88528887e-01,  2.87699050e-01,  4.66891721e-02,  1.24621054e-01,  7.19837510e-01, -6.82928375e-03],
            [-1.10418638e-01, -3.90631703e-02,  1.81921805e-02,  3.16051947e-02, -1.84231551e-02,  1.96203717e-02,  1.77329131e-02],
            [-6.47566783e-01, -1.09975670e-01, -2.96020646e-02,  2.62021655e-01, -2.81437661e-01, -3.46338931e-01,  1.90799970e-01]
        ]), dh_prev)

if __name__ == "__main__":
    unittest.main()
